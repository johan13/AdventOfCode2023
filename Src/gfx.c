#include <stdint.h>
#include "main.h"
#include "decompress.h"

static const uint16_t font[][16];
static const uint16_t line_height = 20;

static uint16_t x, y;

void draw_header()
{
    decompress("header", OVERLAY_FRAME_BUF, 95 * 400);
    x = 0;
    y = 95;
}

void set_x_pos(int new_x)
{
    x = new_x;
}

static const uint16_t *get_char(char ch)
{
    if (ch == '-')
        return font[0];
    if (ch == '.')
        return font[1];
    if (ch >= '0' && ch <= '9')
        return font[ch - '0' + 2];
    if (ch >= 'A' && ch <= 'Z')
        return font[ch - 'A' + 12];
    return NULL;
}

static int width_of_char(char c)
{
    const uint16_t *rows = get_char(c);
    if (rows == NULL)
        return 12;

    int max_width = 0;
    for (int y = 0; y < 16; y++)
    {
        uint16_t row = rows[y];
        int width = 0;
        while (row)
        {
            ++width;
            row <<= 1;
        }
        max_width = width > max_width ? width : max_width;
    }

    return max_width;
}

int width_of_string(const char *str)
{
    int width = 0;

    for (; *str; str++)
    {
        width += width_of_char(*str) + 2;
    }

    return width;
}

void draw_char(int ch)
{
    if (ch == '\n')
    {
        x = 0; // Newline implies carriage return.
        y += line_height;
        return;
    }

    const uint16_t *data = get_char(ch);
    if (data) {
        uint16_t max_width = 0;
        uint8_t *out_ptr = &OVERLAY_FRAME_BUF[y * OVERLAY_WIDTH + x];
        for (uint16_t dy = 0; dy < 16; dy++)
        {
            uint16_t ch_row = data[dy];
            uint16_t dx = 0;
            for (;;)
            {
                out_ptr[dx] = ch_row & 0x8000 ? 0xff : 0x00;
                ch_row <<= 1;
                dx++;
                if (!ch_row)
                    break;
            }

            max_width = dx > max_width ? dx : max_width;
            out_ptr += OVERLAY_WIDTH;
        }

        x += max_width;
    } else {
        x += 12;
    }

    x += 2;
}

// clang-format off

// O4font by Yuji Oshimoto. Freeware. Characters are 16 px high and up to 15 pixels wide.
// Leave 2 px horizontal spacing and 1 px vertical. Spaces are 12 (+2) px.
static const uint16_t font[][16] = {
    { 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x7fe0, 0x9ff0, 0xbff0, 0xfff0, 0x7fe0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000 }, // -
    { 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x7000, 0x9800, 0xb800, 0xf800, 0x7000, 0x0000, 0x0000, 0x0000 }, // .
    { 0x3ff0, 0x1ff8, 0xbffc, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfffc, 0xfffc, 0x7ff8, 0x3ff0, 0x0000, 0x0000 }, // 0
    { 0x7f00, 0x9f80, 0xbf80, 0x7f80, 0x3f80, 0x3f80, 0x3f80, 0x3f80, 0x3f80, 0x3f80, 0x3f80, 0x3f80, 0x3f80, 0x1f00, 0x0000, 0x0000 }, // 1
    { 0x7ff0, 0x9ff8, 0xbffc, 0x7ffc, 0x007c, 0x3ffc, 0x7ff8, 0xfff0, 0xfe00, 0xfff8, 0xfffc, 0xfffc, 0xfffc, 0x7ff8, 0x0000, 0x0000 }, // 2
    { 0x3ff0, 0x1ff8, 0xbffc, 0x7ffc, 0x003c, 0x3ffc, 0x7ffc, 0x3ffc, 0x003c, 0x7ffc, 0xfffc, 0xfffc, 0x7ff8, 0x3ff0, 0x0000, 0x0000 }, // 3
    { 0x78e0, 0x9df0, 0xbdf0, 0xfdf0, 0xfdf0, 0xfdf0, 0xfdf0, 0xfff8, 0xfffc, 0x7ffc, 0x3ff8, 0x01f0, 0x01f0, 0x00e0, 0x0000, 0x0000 }, // 4
    { 0x7ff8, 0x9ffc, 0xbffc, 0xfff8, 0xfe00, 0xfff0, 0xfff8, 0x7ffc, 0x007c, 0x7ffc, 0xfffc, 0xfffc, 0xfff8, 0x7ff0, 0x0000, 0x0000 }, // 5
    { 0x3ff0, 0x1ff8, 0xbff0, 0xfe00, 0xfe00, 0xfff0, 0xfff8, 0xfffc, 0xfe3c, 0xfe3c, 0xfffc, 0xfffc, 0x7ff8, 0x3ff0, 0x0000, 0x0000 }, // 6
    { 0x7ff8, 0x9ffc, 0xbffc, 0x7ffc, 0x01fc, 0x03f8, 0x07f0, 0x07e0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0780, 0x0000, 0x0000 }, // 7
    { 0x3ff0, 0x1ff8, 0xbffc, 0xfe3c, 0xfe3c, 0xfffc, 0x7ff8, 0xfffc, 0xfe3c, 0xfe3c, 0xfffc, 0xfffc, 0x7ff8, 0x3ff0, 0x0000, 0x0000 }, // 8
    { 0x3ff0, 0x1ff8, 0xbffc, 0xfe3c, 0xfe3c, 0xfffc, 0x7ffc, 0x3ff8, 0x01f8, 0x03f0, 0x07e0, 0x0fc0, 0x1f80, 0x0f00, 0x0000, 0x0000 }, // 9
    { 0x3fe0, 0x1ff0, 0xbff8, 0xfe3c, 0xfe3c, 0xfffc, 0xfffc, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0x7c18, 0x0000, 0x0000 }, // A
    { 0x7ff0, 0x9ff8, 0xbffc, 0xfe3c, 0xfe3c, 0xfffc, 0xfff8, 0xfffc, 0xfe3c, 0xfe3c, 0xfffc, 0xfffc, 0xfff8, 0x7ff0, 0x0000, 0x0000 }, // B
    { 0x3ff8, 0x1ffc, 0xbff8, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfff8, 0xfffc, 0x7ffc, 0x3ff8, 0x0000, 0x0000 }, // C
    { 0x7fe0, 0x9ff0, 0xbff8, 0xfe7c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe7c, 0xfffc, 0xfffc, 0xfff8, 0x7ff0, 0x0000, 0x0000 }, // D
    { 0x7ff8, 0x9ffc, 0xbff8, 0xfe00, 0xfe00, 0xfff8, 0xfffc, 0xfff8, 0xfe00, 0xfe00, 0xfff8, 0xfffc, 0xfffc, 0x7ff8, 0x0000, 0x0000 }, // E
    { 0x7ff8, 0x9ffc, 0xbff8, 0xfe00, 0xfe00, 0xfff8, 0xfffc, 0xfff8, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0x7c00, 0x0000, 0x0000 }, // F
    { 0x3ff8, 0x1ffc, 0xbff8, 0xfe00, 0xfe00, 0xfe78, 0xfefc, 0xfe7c, 0xfe3c, 0xfe3c, 0xfffc, 0xfffc, 0x7ff8, 0x3ff0, 0x0000, 0x0000 }, // G
    { 0x7c38, 0x9e7c, 0xbe7c, 0xfe7c, 0xfe7c, 0xfffc, 0xfffc, 0xfffc, 0xfe7c, 0xfe7c, 0xfe7c, 0xfe7c, 0xfe7c, 0x7c38, 0x0000, 0x0000 }, // H
    { 0x7c00, 0x9e00, 0xbe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0x7c00, 0x0000, 0x0000 }, // I
    { 0x00f8, 0x013c, 0x017c, 0x01fc, 0x01fc, 0x01fc, 0x71fc, 0xf9fc, 0xf9fc, 0xf9fc, 0xfffc, 0xfffc, 0x7ff8, 0x3ff0, 0x0000, 0x0000 }, // J
    { 0x7c18, 0x9e3c, 0xbe7c, 0xfefc, 0xfff8, 0xfff0, 0xffe0, 0xfff0, 0xfff8, 0xfffc, 0xfefc, 0xfe7c, 0xfe3c, 0x7c18, 0x0000, 0x0000 }, // K
    { 0x7c00, 0x9e00, 0xbe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfe00, 0xfff0, 0xfff8, 0xfff8, 0x7ff0, 0x0000, 0x0000 }, // L
    { 0x7c1c, 0x9e3e, 0xbe3e, 0xfe3e, 0xfe3e, 0xff7e, 0xfffe, 0xfffe, 0xfffe, 0xfffe, 0xfebe, 0xfe3e, 0xfe3e, 0x7c1c, 0x0000, 0x0000 }, // M
    { 0x7c38, 0x9e7c, 0xbe7c, 0xfe7c, 0xfe7c, 0xff7c, 0xfffc, 0xfffc, 0xfffc, 0xfefc, 0xfe7c, 0xfe7c, 0xfe7c, 0x7c38, 0x0000, 0x0000 }, // N
    { 0x3ff0, 0x1ff8, 0xbffc, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfffc, 0xfffc, 0x7ff8, 0x3ff0, 0x0000, 0x0000 }, // O
    { 0x7ff0, 0x9ff8, 0xbffc, 0xfe7c, 0xfe7c, 0xfe7c, 0xfe7c, 0xfffc, 0xfff8, 0xfff0, 0xfe00, 0xfe00, 0xfe00, 0x7c00, 0x0000, 0x0000 }, // P
    { 0x3ff0, 0x1ff8, 0xbffc, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfe3c, 0xfffc, 0xfffc, 0x7ff8, 0x3ff0, 0x01f0, 0x00f0 }, // Q
    { 0x7ff0, 0x9ff8, 0xbffc, 0xfe3c, 0xfe3c, 0xfffc, 0xfff8, 0xfff0, 0xfff8, 0xfffc, 0xfefc, 0xfe7c, 0xfe3c, 0x7c18, 0x0000, 0x0000 }, // R
    { 0x3ff8, 0x1ffc, 0xbffc, 0xfff8, 0xfe00, 0xfff8, 0xfffc, 0x7ffc, 0x007c, 0x7ffc, 0xfffc, 0xfffc, 0xfff8, 0x7ff0, 0x0000, 0x0000 }, // S
    { 0x7ff8, 0x9ffc, 0xbffc, 0x7ff8, 0x0fc0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0780, 0x0000, 0x0000 }, // T
    { 0x7c38, 0x9e7c, 0xbe7c, 0xfe7c, 0xfe7c, 0xfe7c, 0xfe7c, 0xfe7c, 0xfe7c, 0xfe7c, 0xfffc, 0xfffc, 0x7ff8, 0x3ff0, 0x0000, 0x0000 }, // U
    { 0x7c38, 0x9e7c, 0xbe7c, 0xfe7c, 0xfe7c, 0xfe7c, 0xfe7c, 0xfefc, 0xfff8, 0xfff0, 0xffe0, 0xffc0, 0x7f80, 0x3f00, 0x0000, 0x0000 }, // V
    { 0x7c1c, 0x9e3e, 0xbe3e, 0xfe3e, 0xfe3e, 0xfe3e, 0xfebe, 0xfffe, 0xfffe, 0xfffe, 0xfffe, 0xff7e, 0xfe3e, 0x7c1c, 0x0000, 0x0000 }, // W
    { 0x7038, 0x987c, 0xbcfc, 0xfffc, 0x7ff8, 0x3ff0, 0x1fe0, 0x1fe0, 0x3ff0, 0x7ff8, 0xfffc, 0xfcfc, 0xf87c, 0x7038, 0x0000, 0x0000 }, // X
    { 0x7878, 0x9cfc, 0xbffc, 0xfffc, 0x7ff8, 0x3ff0, 0x1fe0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0fc0, 0x0780, 0x0000, 0x0000 }, // Y
    { 0x7ff8, 0x9ffc, 0xbffc, 0x7ffc, 0x03f8, 0x07f0, 0x0fe0, 0x1fc0, 0x3f80, 0x7ff8, 0xfffc, 0xfffc, 0xfffc, 0x7ff8, 0x0000, 0x0000 }, // Z
};
